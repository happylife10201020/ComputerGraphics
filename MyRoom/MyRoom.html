<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Material, Light and Shaodw</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        canvas {
            display: block;
        }
    </style>

    <script type="importmap">
        {
            "imports" : {
                "three" : "https://unpkg.com/three@0.150.1/build/three.module.js",
                "three/addons/" : "https://unpkg.com/three@0.150.1/examples/jsm/",
                "three/examples/jsm/controls/DragControls.js": "https://unpkg.com/three@0.150.1/examples/jsm/controls/DragControls.js"
            }
        }
    </script>
</head>

<body>
<div id="WebGL-output"></div>
<script type="module">
    import * as THREE from "three" ;
    import {OrbitControls} from "three/addons/controls/OrbitControls.js" ;
    import {DragControls} from 'three/examples/jsm/controls/DragControls.js';

    const scene = new THREE.Scene();
    scene.background = new THREE.Color("darkgray");

    const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(100, 100, 100);

    const renderer = new THREE.WebGLRenderer({antialias: true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.getElementById("WebGL-output").appendChild(renderer.domElement);


    // ====================================================================
    // 헬퍼 함수: 박스 메쉬를 생성 이름 지정 (높이 자동 조정)
    // ====================================================================
    function createBoxMesh(width, height, depth, color, name = '') {
        const geometry = new THREE.BoxGeometry(width, height, depth);
        const material = new THREE.MeshStandardMaterial({color: color});
        const mesh = new THREE.Mesh(geometry, material);
        mesh.name = name;
        return mesh;
    }

    // ====================================================================
    // 1. 방 기본 구조 
    // ====================================================================
    const axes = new THREE.AxesHelper(200);
    scene.add(axes);

    const plane = createBoxMesh(100, 1, 100, 'yellow', 'plane'); // BoxGeometry로 변경
    plane.position.set(0, -0.5, 0); // 바닥 높이 조정
    scene.add(plane);

    const wall_1 = new THREE.Mesh(
        new THREE.PlaneGeometry(100, 70),
        new THREE.MeshStandardMaterial({color: 'white'})
    );
    wall_1.rotation.set(0, 0, 0);
    wall_1.position.set(0, 35, -50);
    scene.add(wall_1);

    const wall_2 = new THREE.Mesh(
        new THREE.BoxGeometry(100, 70),
        new THREE.MeshStandardMaterial({color: 'white'})
    );
    wall_2.rotation.set(0, 0.5 * Math.PI, 0);
    wall_2.position.set(-50, 35, 0);
    scene.add(wall_2);

    const wall_3 = new THREE.Mesh(
        new THREE.PlaneGeometry(100, 70),
        new THREE.MeshStandardMaterial({color: 'white'})
    );
    wall_3.rotation.set(-Math.PI, 0, 0);
    wall_3.position.set(0, 35, 50);
    scene.add(wall_3);

    const roof = new THREE.Mesh(
        new THREE.PlaneGeometry(100, 100),
        new THREE.MeshStandardMaterial({color: 'lightgray'})
    );
    roof.rotation.set(0.5 * Math.PI, 0, 0);
    roof.position.set(0, 70, 0);
    scene.add(roof);


    // ====================================================================
    // 2. 문과 창문 그룹
    // ====================================================================

    // 2-1. Door and Handle
    const Door = createBoxMesh(15, 30, 1, 'brown', 'Door');
    Door.rotation.set(0, Math.PI, 0);
    Door.position.set(40, 15, 49.5);
    scene.add(Door);

    const DoorHandle = createBoxMesh(1, 1, 1, 'gold', 'DoorHandle');
    DoorHandle.position.set(5, 0, 0); // 문을 기준으로 상대 위치
    Door.add(DoorHandle); // Door가 DoorHandle의 부모가 됨


    // 2-2. Window Groups (Window_1, Window_2, Window_3)
    function createWindowGroup(width, height, color, pos_x, pos_y, pos_z, name, rotation) {
        const group = new THREE.Group();
        group.position.set(pos_x, pos_y, pos_z);
        group.rotation.set(rotation.x, rotation.y, rotation.z);
        group.name = name;

        const windowMesh = createBoxMesh(width, height, 1, color, 'Window');
        windowMesh.material.opacity = 0.6;
        windowMesh.material.transparent = true;
        group.add(windowMesh);

        const curtainRod = createBoxMesh(width + 2, 1, 1, 0x333333, 'CurtainRod');
        curtainRod.position.y = (height / 2) + 1;
        group.add(curtainRod);

        const curtain = createBoxMesh(width, height, 0.5, 0xFFEBCD, 'Curtain');
        curtain.position.z = 0.5;
        group.add(curtain);

        return group;
    }

    // 기존 창문 위치에 그룹 적용
    const winRotation = new THREE.Vector3(0, Math.PI, 0);
    const Window_1_Group = createWindowGroup(35, 35, 'lightblue', -20, 40, -49.5, 'Window_1_Group', winRotation);
    scene.add(Window_1_Group);

    const Window_2_Group = createWindowGroup(35, 35, 'lightblue', 20, 40, -49.5, 'Window_2_Group', winRotation);
    scene.add(Window_2_Group);

    // Window_3 추가
    const Window_3_Group = createWindowGroup(35, 35, 'lightblue', -49.5, 40, 20, 'Window_3_Group', new THREE.Vector3(0, Math.PI / 2, 0));
    scene.add(Window_3_Group);


    // ====================================================================
    // 3. 가구 그룹 
    // ====================================================================

    // 3-1. Bedding Group
    const beddingGroup = new THREE.Group();
    // 기존 침대 위치를 그룹의 기준으로 사용
    beddingGroup.position.set(-10, 0, -15);
    beddingGroup.rotation.set(0, Math.PI / 2, 0);
    beddingGroup.name = 'Bedding Group';

    // 기존 침대 메쉬를 그룹의 자식으로 추가
    const bedMesh = createBoxMesh(40, 10, 60, 'pink', 'bed');
    bedMesh.position.y = 5; // 그룹 기준 중앙에서 바닥에 붙도록 조정
    beddingGroup.add(bedMesh);

    const BedHead = createBoxMesh(62, 30, 3, 0x8B4513, 'BedHead');
    BedHead.position.set(0, 15, -31.5);
    beddingGroup.add(BedHead);

    const Pillow1 = createBoxMesh(15, 5, 20, 0xFFFFFF, 'Pillow1');
    Pillow1.position.set(-10, 8.5, -20);
    beddingGroup.add(Pillow1);

    const Pillow2 = createBoxMesh(15, 5, 20, 0xFFFFFF, 'Pillow2');
    Pillow2.position.set(10, 8.5, -20);
    beddingGroup.add(Pillow2);

    const BottomSheet = createBoxMesh(40, 0.5, 60, 0x00FF00, 'BottomSheet');
    BottomSheet.position.y = 10.25;
    beddingGroup.add(BottomSheet);

    const Duvet = createBoxMesh(40, 4, 45, 0x00FFFF, 'Duvet');
    Duvet.position.set(0, 10.5, 7.5);
    beddingGroup.add(Duvet);

    scene.add(beddingGroup);


    // 3-2. Desk Setup Group
    const deskSetupGroup = new THREE.Group();
    deskSetupGroup.name = 'Desk Setup Group';

    deskSetupGroup.position.set(30, 0, -10);
    deskSetupGroup.rotation.y = Math.PI / 2;

    // 상판 + 다리 4개
    const deskTop = createBoxMesh(60, 3, 30, 0x8B8680, 'DeskTop');
    deskTop.position.y = 18;
    deskSetupGroup.add(deskTop);

    // 책상 다리 (4개)
    const legPositions = [
        [-28, 9, -13],
        [28, 9, -13],
        [-28, 9, 13],
        [28, 9, 13],
    ];

    legPositions.forEach((pos, i) => {
        const leg = createBoxMesh(3,18, 3, 0x555555, `DeskLeg_${i + 1}`);
        leg.position.set(...pos);
        deskSetupGroup.add(leg);
    });

    // 모니터 2개
    const Monitor1 = createBoxMesh(12, 7.5, 1, 0x111111, 'Monitor1');
    Monitor1.position.set(-10, 24, -5);
    deskSetupGroup.add(Monitor1);

    const Monitor2 = createBoxMesh(20 , 13, 1, 0x111111, 'Monitor2');
    Monitor2.position.set(7, 24, -5);
    deskSetupGroup.add(Monitor2);

    // 키보드, 마우스, 마우스패드
    const Keyboard = createBoxMesh(25, 0.5, 10, 0x222222, 'Keyboard');
    Keyboard.position.set(-5, 20, 5);
    deskSetupGroup.add(Keyboard);

    const MousePad = createBoxMesh(10, 0.25, 10, 0x555555, 'MousePad');
    MousePad.position.set(15, 20, 5);
    deskSetupGroup.add(MousePad);

    const Mouse = createBoxMesh(3, 0.5, 5, 0x333333, 'Mouse');
    Mouse.position.set(15, 20, 5);
    deskSetupGroup.add(Mouse);

    // 본체
    const Computer = createBoxMesh(6, 18, 15, 0x444444, 'Computer');
    Computer.position.set(30, 4, 0);
    deskSetupGroup.add(Computer);

    // 스피커
    const Speaker1 = createBoxMesh(3, 3, 3, 0x000000, 'Speaker1');
    Speaker1.position.set(-20, 19.5, -12);
    deskSetupGroup.add(Speaker1);

    const Speaker2 = createBoxMesh(3, 3, 3, 0x000000, 'Speaker2');
    Speaker2.position.set(20, 19.5, -12);
    deskSetupGroup.add(Speaker2);

    scene.add(deskSetupGroup);


    // 3-3. Storage Group
    const storageGroup = new THREE.Group();
    storageGroup.position.set(-35, 0, 50);
    storageGroup.name = 'Storage Group';

    // 책장
    const Bookshelf = createBoxMesh(15, 40, 15 , 0xAA8866, 'Bookshelf');
    Bookshelf.position.set(78, 20, -18);
    storageGroup.add(Bookshelf);

    // 책
    const Book1 = createBoxMesh(1, 10, 8, 0x990000, 'Book1');
    Book1.position.set(-18, 30, 0);
    storageGroup.add(Book1);

    const Book2 = createBoxMesh(1, 10, 8, 0x009900, 'Book2');
    Book2.position.set(-16, 30, 0);
    storageGroup.add(Book2);

    // 옷장
    const Wardrobe = createBoxMesh(40, 50, 10, 0x664422, 'Wardrobe');
    Wardrobe.position.set(5, 25, -5); 
    storageGroup.add(Wardrobe);

    scene.add(storageGroup);


    // 4. 기타 단일 객체
    const AirPurifier = createBoxMesh(10, 20, 10, 0xEEEEEE, 'AirPurifier');
    AirPurifier.position.set(15, 10, 45);
    scene.add(AirPurifier);

    const BassGuitar = createBoxMesh(5, 50, 1, 0x442200, 'BassGuitar');
    BassGuitar.position.set(-48, 25, -40); 
    BassGuitar.rotation.z = Math.PI / 12;
    scene.add(BassGuitar);

    const Picture = createBoxMesh(20, 15, 0.5, 0xCCCCCC, 'Picture');
    Picture.position.set(20, 50, -49.75); 
    scene.add(Picture);

    const Lamp1 = createBoxMesh(5, 5, 5, 0xFFD700, 'Lamp1');
    Lamp1.position.set(-40, 65, 40);
    scene.add(Lamp1);

    const Lamp2 = createBoxMesh(5, 5, 5, 0xFFD700, 'Lamp2');
    Lamp2.position.set(40, 65, -40);
    scene.add(Lamp2);

    const PowerStrip = createBoxMesh(3, 5, 0.5, 0xcccccc, 'PowerStrip');
    PowerStrip.position.set(25, 25, 50); 
    scene.add(PowerStrip);

    const LightSwitch = createBoxMesh(5, 5, 0.5, 0xFFFFFF, 'LightSwitch');
    LightSwitch.position.set(49.75, 4, 10); 
    scene.add(LightSwitch);


    //Light
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.3);
    scene.add(ambientLight);

    const sunLight = new THREE.DirectionalLight(0xfff2cc, 1);
    sunLight.position.set(100, 200, 100);
    sunLight.castShadow = true;
    scene.add(sunLight);

    const pointLight = new THREE.PointLight(0xffeeaa, 0.6, 300);
    pointLight.position.set(0, 60, 0);
    scene.add(pointLight);


    // ====================================================================
    // 5. Controls (DragControls 대상 변경)
    // ====================================================================

    const draggableObjects = [
        beddingGroup,
        deskSetupGroup,
        Door,
        AirPurifier,
        BassGuitar,
    ];
    let dragControls = new DragControls(
        draggableObjects,
        camera,
        renderer.domElement
    )

    const orbitControls = new OrbitControls(camera, renderer.domElement);
    orbitControls.update();

    dragControls.addEventListener('dragstart', function (event) {
        orbitControls.enabled = false;
    });
    dragControls.addEventListener('drag', function (event) {
    });
    dragControls.addEventListener('dragend', function (event) {
        orbitControls.enabled = true;
    });

    function animate() {
        requestAnimationFrame(animate);
        orbitControls.update();
        renderer.render(scene, camera);
    }

    animate();

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });
</script>
</body>
</html>